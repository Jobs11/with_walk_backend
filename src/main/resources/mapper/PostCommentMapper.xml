<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.with_walk.mapper.PostCommentMapper">

    <!-- üÜï ResultMap Ï∂îÍ∞Ä (Î™ÖÏãúÏ†Å Îß§Ìïë) -->
    <resultMap id="PostCommentResultMap" type="com.example.with_walk.dto.PostCommentDTO">
        <id property="pcNum" column="pc_num"/>
        <result property="pNum" column="p_num"/>
        <result property="parentPcNum" column="parent_pc_num"/>  <!-- ‚úÖ Ï∂îÍ∞Ä -->
        <result property="mId" column="m_id"/>
        <result property="pcContent" column="pc_content"/>
        <result property="pcDate" column="pc_date"/>
        <result property="authorName" column="author_name"/>
        <result property="authorImage" column="author_image"/>
        <result property="mNickname" column="m_nickname"/>  <!-- ‚úÖ Ï∂îÍ∞Ä -->
        <result property="mProfileImage" column="m_profile_image"/>  <!-- ‚úÖ Ï∂îÍ∞Ä -->
        <result property="isLiked" column="is_liked"/>
        <result property="likeCount" column="like_count"/>
        <result property="isLikedByAuthor" column="is_liked_by_author"/>
    </resultMap>

    <!-- ÎåìÍ∏Ä Î™©Î°ù Ï°∞Ìöå (Ï¢ãÏïÑÏöî Ï†ïÎ≥¥ Ìè¨Ìï®) -->
    <select id="selectCommentsByPostId" resultType="com.example.with_walk.dto.PostCommentDTO">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.parent_pc_num,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            m.m_nickname as m_nickname,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            m.m_profile_image as m_profile_image,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            COALESCE(COUNT(DISTINCT pcl.pcl_num), 0) as like_count,
            MAX(CASE WHEN pcl.m_id = #{mId} THEN 1 ELSE 0 END) as is_liked
        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
        WHERE pc.p_num = #{pNum}
        AND pc.pc_status = 'Í≥µÍ∞ú'
        GROUP BY pc.pc_num, pc.p_num, pc.parent_pc_num, pc.m_id, pc.pc_content, pc.pc_date,
                 m.m_nickname, m.m_profile_image
        ORDER BY
            COALESCE(pc.parent_pc_num, pc.pc_num),  <!-- ‚úÖ Í≥ÑÏ∏µ Ï†ïÎ†¨ -->
            pc.parent_pc_num IS NULL DESC,
            pc.pc_date ASC
    </select>

    <!-- ÎåìÍ∏Ä ÏûëÏÑ± -->
    <insert id="insertComment" parameterType="com.example.with_walk.dto.PostCommentDTO"
            useGeneratedKeys="true" keyProperty="pcNum">
        INSERT INTO post_comments (p_num, parent_pc_num, m_id, pc_content, pc_date)  <!-- ‚úÖ parent_pc_num Ï∂îÍ∞Ä -->
        VALUES (#{pNum}, #{parentPcNum}, #{mId}, #{pcContent}, #{pcDate})
    </insert>

    <!-- ÎåìÍ∏Ä ÏÇ≠Ï†ú -->
    <delete id="deleteComment">
        UPDATE post_comments SET pc_status = 'ÎπÑÍ≥µÍ∞ú' WHERE pc_num = #{pcNum}
    </delete>

    <!-- ÎåìÍ∏Ä Ïàò Ï°∞Ìöå -->
    <select id="countCommentsByPostId" resultType="int">
        SELECT COUNT(*)
        FROM post_comments
        WHERE p_num = #{pNum}
        AND pc_status = 'Í≥µÍ∞ú'
    </select>

    <!-- ÌäπÏ†ï ÎåìÍ∏Ä Ï°∞Ìöå -->
    <select id="selectCommentById" resultType="com.example.with_walk.dto.PostCommentDTO">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.parent_pc_num,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            m.m_nickname as m_nickname,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            m.m_profile_image as m_profile_image,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            0 as like_count,
            0 as is_liked
        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        WHERE pc.pc_num = #{pcNum}
    </select>

    <!-- üî¥ ÏàòÏ†ïÎêú getCommentList - resultMap ÏÇ¨Ïö© + parent_pc_num Ï∂îÍ∞Ä -->
    <select id="getCommentList" resultMap="PostCommentResultMap">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.parent_pc_num,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            m.m_nickname as m_nickname,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            m.m_profile_image as m_profile_image,  <!-- ‚úÖ Ï∂îÍ∞Ä -->

            -- ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÍ∞Ä Ï¢ãÏïÑÏöî ÎàåÎ†ÄÎäîÏßÄ
            CASE WHEN pcl.m_id IS NOT NULL THEN true ELSE false END as is_liked,

            -- Ï¢ãÏïÑÏöî Í∞úÏàò
            (SELECT COUNT(*)
             FROM post_comment_likes
             WHERE pc_num = pc.pc_num) as like_count,

            -- Í≤åÏãúÍ∏Ä ÏûëÏÑ±ÏûêÍ∞Ä Ïù¥ ÎåìÍ∏ÄÏóê Ï¢ãÏïÑÏöî ÎàåÎ†ÄÎäîÏßÄ
            CASE WHEN EXISTS(
                SELECT 1
                FROM post_comment_likes pcl2
                WHERE pcl2.pc_num = pc.pc_num
                AND pcl2.m_id = (
                    SELECT p.m_id
                    FROM posts p
                    WHERE p.p_num = pc.p_num
                )
            ) THEN true ELSE false END as is_liked_by_author

        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
            AND pcl.m_id = #{user_id}
        WHERE pc.p_num = #{pNum}
        AND pc.pc_status = 'Í≥µÍ∞ú'  <!-- ‚úÖ Ï∂îÍ∞Ä -->
        ORDER BY
            COALESCE(pc.parent_pc_num, pc.pc_num),  <!-- ‚úÖ Í≥ÑÏ∏µ Ï†ïÎ†¨ -->
            pc.parent_pc_num IS NULL DESC,
            pc.pc_date ASC
    </select>

    <!-- Îã®Ïùº ÎåìÍ∏Ä Ï°∞Ìöå ÏøºÎ¶¨ Ï∂îÍ∞Ä -->
    <select id="getCommentByIdWithLikeInfo" resultMap="PostCommentResultMap">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.parent_pc_num,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            m.m_nickname as m_nickname,  <!-- ‚úÖ Ï∂îÍ∞Ä -->
            m.m_profile_image as m_profile_image,  <!-- ‚úÖ Ï∂îÍ∞Ä -->

            -- ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÍ∞Ä Ï¢ãÏïÑÏöî ÎàåÎ†ÄÎäîÏßÄ
            CASE WHEN pcl.m_id IS NOT NULL THEN true ELSE false END as is_liked,

            -- Ï¢ãÏïÑÏöî Í∞úÏàò
            (SELECT COUNT(*)
            FROM post_comment_likes
            WHERE pc_num = pc.pc_num) as like_count,

            -- Í≤åÏãúÍ∏Ä ÏûëÏÑ±ÏûêÍ∞Ä Ïù¥ ÎåìÍ∏ÄÏóê Ï¢ãÏïÑÏöî ÎàåÎ†ÄÎäîÏßÄ
            CASE WHEN EXISTS(
                SELECT 1
                FROM post_comment_likes pcl2
                WHERE pcl2.pc_num = pc.pc_num
                AND pcl2.m_id = (
                    SELECT p.m_id
                    FROM posts p
                    WHERE p.p_num = pc.p_num
                )
            ) THEN true ELSE false END as is_liked_by_author

        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
            AND pcl.m_id = #{user_id}
        WHERE pc.pc_num = #{pcNum}
    </select>

    <!-- üÜï Í≤åÏãúÍ∏Ä ÏûëÏÑ±ÏûêÍ∞Ä ÌäπÏ†ï ÎåìÍ∏ÄÏóê Ï¢ãÏïÑÏöî ÎàåÎ†ÄÎäîÏßÄ ÌôïÏù∏ -->
    <select id="isLikedByPostAuthor" resultType="boolean">
        SELECT CASE WHEN EXISTS(
            SELECT 1
            FROM post_comment_likes pcl
            WHERE pcl.pc_num = #{pcNum}
            AND pcl.m_id = (
                SELECT p.m_id
                FROM posts p
                JOIN post_comments pc ON p.p_num = pc.p_num
                WHERE pc.pc_num = #{pcNum}
            )
        ) THEN true ELSE false END
    </select>

    <!-- ‚úÖ Ï∂îÍ∞Ä: ÎåÄÎåìÍ∏ÄÎßå Ï°∞Ìöå (ÌäπÏ†ï Î∂ÄÎ™® ÎåìÍ∏ÄÏùò) -->
    <select id="selectRepliesByParentPcNum" resultMap="PostCommentResultMap">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.parent_pc_num,
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            m.m_nickname as m_nickname,
            m.m_profile_image as m_profile_image,

            CASE WHEN pcl.m_id IS NOT NULL THEN true ELSE false END as is_liked,

            (SELECT COUNT(*)
             FROM post_comment_likes
             WHERE pc_num = pc.pc_num) as like_count,

            CASE WHEN EXISTS(
                SELECT 1
                FROM post_comment_likes pcl2
                WHERE pcl2.pc_num = pc.pc_num
                AND pcl2.m_id = (
                    SELECT p.m_id
                    FROM posts p
                    WHERE p.p_num = pc.p_num
                )
            ) THEN true ELSE false END as is_liked_by_author

        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
            AND pcl.m_id = #{user_id}
        WHERE pc.parent_pc_num = #{parentPcNum}
        AND pc.pc_status = 'Í≥µÍ∞ú'
        ORDER BY pc.pc_date ASC
    </select>

    <!-- ‚úÖ Ï∂îÍ∞Ä: Î∂ÄÎ™® ÎåìÍ∏ÄÎßå Ï°∞Ìöå -->
    <select id="selectParentComments" resultMap="PostCommentResultMap">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.parent_pc_num,
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            m.m_nickname as m_nickname,
            m.m_profile_image as m_profile_image,

            CASE WHEN pcl.m_id IS NOT NULL THEN true ELSE false END as is_liked,

            (SELECT COUNT(*)
             FROM post_comment_likes
             WHERE pc_num = pc.pc_num) as like_count,

            CASE WHEN EXISTS(
                SELECT 1
                FROM post_comment_likes pcl2
                WHERE pcl2.pc_num = pc.pc_num
                AND pcl2.m_id = (
                    SELECT p.m_id
                    FROM posts p
                    WHERE p.p_num = pc.p_num
                )
            ) THEN true ELSE false END as is_liked_by_author

        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
            AND pcl.m_id = #{user_id}
        WHERE pc.p_num = #{pNum}
        AND pc.parent_pc_num IS NULL  <!-- ‚úÖ Î∂ÄÎ™® ÎåìÍ∏ÄÎßå -->
        AND pc.pc_status = 'Í≥µÍ∞ú'
        ORDER BY pc.pc_date DESC
    </select>

    <!-- ‚úÖ Ï∂îÍ∞Ä: ÌäπÏ†ï ÎåìÍ∏ÄÏùò ÎåÄÎåìÍ∏Ä Ïàò Ï°∞Ìöå -->
    <select id="countRepliesByParentPcNum" resultType="int">
        SELECT COUNT(*)
        FROM post_comments
        WHERE parent_pc_num = #{parentPcNum}
        AND pc_status = 'Í≥µÍ∞ú'
    </select>

</mapper>
