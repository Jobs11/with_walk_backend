<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.with_walk.mapper.PostCommentMapper">

    <!-- ğŸ†• ResultMap ì¶”ê°€ (ëª…ì‹œì  ë§¤í•‘) -->
    <resultMap id="PostCommentResultMap" type="com.example.with_walk.dto.PostCommentDTO">
        <id property="pcNum" column="pc_num"/>
        <result property="pNum" column="p_num"/>
        <result property="mId" column="m_id"/>
        <result property="pcContent" column="pc_content"/>
        <result property="pcDate" column="pc_date"/>
        <result property="authorName" column="author_name"/>
        <result property="authorImage" column="author_image"/>
        <result property="isLiked" column="is_liked"/>
        <result property="likeCount" column="like_count"/>
        <!-- ğŸ”´ í•µì‹¬: ëª…ì‹œì ìœ¼ë¡œ ë§¤í•‘! -->
        <result property="isLikedByAuthor" column="is_liked_by_author"/>
    </resultMap>

    <!-- ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ (ì¢‹ì•„ìš” ì •ë³´ í¬í•¨) -->
    <select id="selectCommentsByPostId" resultType="com.example.with_walk.dto.PostCommentDTO">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            COALESCE(COUNT(DISTINCT pcl.pcl_num), 0) as like_count,
            MAX(CASE WHEN pcl.m_id = #{mId} THEN 1 ELSE 0 END) as is_liked
        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
        WHERE pc.p_num = #{pNum}
        AND pc.pc_status = 'ê³µê°œ'
        GROUP BY pc.pc_num, pc.p_num, pc.m_id, pc.pc_content, pc.pc_date,
                 m.m_name, m.m_profile_image
        ORDER BY pc.pc_date DESC
    </select>

    <!-- ëŒ“ê¸€ ì‘ì„± -->
    <insert id="insertComment" parameterType="com.example.with_walk.dto.PostCommentDTO"
            useGeneratedKeys="true" keyProperty="pcNum">
        INSERT INTO post_comments (p_num, m_id, pc_content, pc_date)
        VALUES (#{pNum}, #{mId}, #{pcContent}, #{pcDate})
    </insert>

    <!-- ëŒ“ê¸€ ì‚­ì œ -->
    <delete id="deleteComment">
        UPDATE post_comments SET pc_status = 'ë¹„ê³µê°œ' WHERE pc_num = #{pcNum}
    </delete>

    <!-- ëŒ“ê¸€ ìˆ˜ ì¡°íšŒ -->
    <select id="countCommentsByPostId" resultType="int">
        SELECT COUNT(*)
        FROM post_comments
        WHERE p_num = #{pNum}
        AND pc_status = 'ê³µê°œ'
    </select>

    <!-- íŠ¹ì • ëŒ“ê¸€ ì¡°íšŒ -->
    <select id="selectCommentById" resultType="com.example.with_walk.dto.PostCommentDTO">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,
            0 as like_count,
            0 as is_liked
        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        WHERE pc.pc_num = #{pcNum}
    </select>

    <!-- ğŸ”´ ìˆ˜ì •ëœ getCommentList - resultMap ì‚¬ìš© -->
    <select id="getCommentList" resultMap="PostCommentResultMap">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,

            -- í˜„ì¬ ì‚¬ìš©ìê°€ ì¢‹ì•„ìš” ëˆŒë €ëŠ”ì§€
            CASE WHEN pcl.m_id IS NOT NULL THEN true ELSE false END as is_liked,

            -- ì¢‹ì•„ìš” ê°œìˆ˜
            (SELECT COUNT(*)
             FROM post_comment_likes
             WHERE pc_num = pc.pc_num) as like_count,

            -- ê²Œì‹œê¸€ ì‘ì„±ìê°€ ì´ ëŒ“ê¸€ì— ì¢‹ì•„ìš” ëˆŒë €ëŠ”ì§€
            CASE WHEN EXISTS(
                SELECT 1
                FROM post_comment_likes pcl2
                WHERE pcl2.pc_num = pc.pc_num
                AND pcl2.m_id = (
                    SELECT p.m_id
                    FROM posts p
                    WHERE p.p_num = pc.p_num
                )
            ) THEN true ELSE false END as is_liked_by_author

        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
            AND pcl.m_id = #{user_id}
        WHERE pc.p_num = #{pNum}
        ORDER BY pc.pc_date DESC
    </select>

    <!-- ë‹¨ì¼ ëŒ“ê¸€ ì¡°íšŒ ì¿¼ë¦¬ ì¶”ê°€ -->
    <select id="getCommentByIdWithLikeInfo" resultMap="PostCommentResultMap">
        SELECT
            pc.pc_num,
            pc.p_num,
            pc.m_id,
            pc.pc_content,
            pc.pc_date,
            m.m_nickname as author_name,
            m.m_profile_image as author_image,

            -- í˜„ì¬ ì‚¬ìš©ìê°€ ì¢‹ì•„ìš” ëˆŒë €ëŠ”ì§€
            CASE WHEN pcl.m_id IS NOT NULL THEN true ELSE false END as is_liked,

            -- ì¢‹ì•„ìš” ê°œìˆ˜
            (SELECT COUNT(*)
            FROM post_comment_likes
            WHERE pc_num = pc.pc_num) as like_count,

            -- ê²Œì‹œê¸€ ì‘ì„±ìê°€ ì´ ëŒ“ê¸€ì— ì¢‹ì•„ìš” ëˆŒë €ëŠ”ì§€
            CASE WHEN EXISTS(
                SELECT 1
                FROM post_comment_likes pcl2
                WHERE pcl2.pc_num = pc.pc_num
                AND pcl2.m_id = (
                    SELECT p.m_id
                    FROM posts p
                    WHERE p.p_num = pc.p_num
                )
            ) THEN true ELSE false END as is_liked_by_author

        FROM post_comments pc
        LEFT JOIN members m ON pc.m_id = m.m_id
        LEFT JOIN post_comment_likes pcl ON pc.pc_num = pcl.pc_num
            AND pcl.m_id = #{user_id}
        WHERE pc.pc_num = #{pcNum}
    </select>

    <!-- ğŸ†• ê²Œì‹œê¸€ ì‘ì„±ìê°€ íŠ¹ì • ëŒ“ê¸€ì— ì¢‹ì•„ìš” ëˆŒë €ëŠ”ì§€ í™•ì¸ -->
    <select id="isLikedByPostAuthor" resultType="boolean">
        SELECT CASE WHEN EXISTS(
            SELECT 1
            FROM post_comment_likes pcl
            WHERE pcl.pc_num = #{pcNum}
            AND pcl.m_id = (
                SELECT p.m_id
                FROM posts p
                JOIN post_comments pc ON p.p_num = pc.p_num
                WHERE pc.pc_num = #{pcNum}
            )
        ) THEN true ELSE false END
    </select>

</mapper>
