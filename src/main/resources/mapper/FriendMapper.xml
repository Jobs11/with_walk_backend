<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.with_walk.mapper.FriendMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="FriendshipResultMap" type="com.example.with_walk.dto.FriendshipDTO">
        <id property="fNum" column="f_num"/>
        <result property="fromUserId" column="from_user_id"/>
        <result property="toUserId" column="to_user_id"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 팔로우 추가 -->
    <insert id="insertFollow" parameterType="com.example.with_walk.dto.FriendshipDTO"
            useGeneratedKeys="true" keyProperty="fNum">
        INSERT INTO friendships (from_user_id, to_user_id, status, created_at)
        VALUES (#{fromUserId}, #{toUserId}, #{status}, #{createdAt})
    </insert>

    <!-- 팔로우 삭제 -->
    <delete id="deleteFollow">
        DELETE FROM friendships
        WHERE from_user_id = #{fromUserId} AND to_user_id = #{toUserId}
    </delete>

    <!-- 팔로우 존재 여부 확인 -->
    <select id="checkFollowExists" resultType="int">
        SELECT COUNT(*) FROM friendships
        WHERE from_user_id = #{fromUserId} AND to_user_id = #{toUserId}
        AND status = 'accepted'
    </select>

    <!-- 팔로워 수 조회 (나를 팔로우하는 사람 수) -->
    <select id="countFollowers" resultType="int">
        SELECT COUNT(*) FROM friendships
        WHERE to_user_id = #{userId} AND status = 'accepted'
    </select>

    <!-- 팔로잉 수 조회 (내가 팔로우하는 사람 수) -->
    <select id="countFollowing" resultType="int">
        SELECT COUNT(*) FROM friendships
        WHERE from_user_id = #{userId} AND status = 'accepted'
    </select>

    <!-- 팔로워 목록 조회 (나를 팔로우하는 사람들) -->
    <select id="selectFollowers" resultMap="FriendshipResultMap">
        SELECT * FROM friendships
        WHERE to_user_id = #{userId} AND status = 'accepted'
        ORDER BY created_at DESC
    </select>

    <!-- 팔로잉 목록 조회 (내가 팔로우하는 사람들) -->
    <select id="selectFollowing" resultMap="FriendshipResultMap">
        SELECT * FROM friendships
        WHERE from_user_id = #{userId} AND status = 'accepted'
        ORDER BY created_at DESC
    </select>

</mapper>
